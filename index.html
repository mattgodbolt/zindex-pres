<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-dag@0.11.1"></script>

    <title>zindex and deflate</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="reveal.js/dist/reset.css">
    <link rel="stylesheet" href="reveal.js/dist/reveal.css">
    <link rel="stylesheet" href="reveal.js/dist/theme/black.css" id="theme">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="reveal.js/plugin/highlight/monokai.css">
    <link rel="stylesheet" href="hufftree.css">
    <style>
        .compress {
            white-space: pre;
            font-family: monospace;
        }

        pre.compress {
            width: auto !important;
            margin: auto !important;
            text-align: center !important;
            box-shadow: none !important;
        }

        textarea.input {
            font-size: xx-large;
            width: 80%;
            height: 1.5em;
            text-align: center;
            resize: none;
        }


        .output .bits {
            font-size: 0.8em;
            font-family: monospace;
        }

        .output .stats {
            font-size: 0.8em;
        }

        svg.huffman-input {
            height: 500px;
        }
    </style>
</head>

<body>

<div class="reveal">
    <div class="slides">
        <section>
            <section>
                <h1>zindex</h1>
            </section>
            <section>
                <h3>My problem</h3>
                <ul>
                    <li>1,000s of historical giant gzip text files</li>
                    <li>Needed to be able to search</li>
                </ul>
            </section>
            <section>
                <ul>
                    <li><code>zgrep</code> is cool!</li>
                    <li class="fragment">...but slow</li>
                </ul>
            </section>
            <section>
                <pre><code data-trim>
godbolt:~ $ ls -hl some-file.csv.gz
505M Oct 14 14:38 some-file.csv.gz
godbolt:~ $ time zgrep AAPL.O some-file.csv.gz | wc -l
864221
Executed in   27.58 secs
                </code></pre>
            </section>
            <section>
                <h3>Enter <code>zq</code></h3>
                <pre><code data-trim>
godbolt:~ 5.2s $ time zq some-file.csv.gz AAPL.O | wc -l
864221
Executed in    4.40 secs
                </code></pre>
            </section>
            <section>
                <h3>The catch</h3>
                <pre class="fragment"><code data-trim>
godbolt:~ $ time zindex -d , -f 1 some-file.csv.gz
Executed in  108.26 secs
                </code></pre>
            </section>
            <section>
                <h3>Dirty secret</h3>
                <pre><code data-trim>
godbolt:~ $ ls -hl some-file.csv.gz.index
2.3G Oct 14 14:43 some-file.csv.gz.zindex
                </code></pre>
            </section>
            <section>
                <h3>More realistic</h3>
                <pre><code data-trim>
godbolt:~ $ zindex ~/some-file.csv.gz
godbolt:~ $ 14.6s $ ls -lh ~/some-file.csv.gz.zindex
629K Oct 14 16:58 some-file.csv.gz.zindex
                </code></pre>
            </section>
        </section>

        <section>
            <section><h2>So how does it work?</h2></section>
            <section>
                <h2>How does DEFLATE work?</h2>
                <ul>
                    <li>Lempel-Ziv</li>
                    <li>Huffman coding</li>
                </ul>
            </section>
        </section>

        <section>
            <section><h2>Lempel-Ziv</h2></section>
            <section>
                <pre class="compress">compress the compressible</pre>
            </section>
            <section>
                <pre class="compress">
0         1         2
0123456789012345678901234
<span
        class="fragment highlight-current-red" data-fragment-index="1"><span
        class="fragment highlight-current-green" data-fragment-index="2">compress</span> the </span><span
        class="fragment highlight-current-red" data-fragment-index="2">compress</span><span
        class="fragment highlight-current-red" data-fragment-index="3">ible</span></pre>
                <pre class="compress fragment" data-fragment-index="1">"compress the "</pre>
                <pre class="compress fragment" data-fragment-index="2">(go back 12, copy 8)</pre>
                <pre class="compress fragment" data-fragment-index="3">"ible"</pre>
                <div class="fragment">
                    13 + (backref, len) + 4
                </div>
            </section>
            <section>
                <h3>Backref?</h3>
                <div>Use new byte values for backref!</div>
                <ul>
                    <li>256 = end of block</li>
                    <li>257 = copy 3</li>
                    <li>258 = copy 4</li>
                    <li>259 = copy 5</li>
                    <li>...etc...</li>
                </ul>
                <div>(offsets coded after)</div>
            </section>
            <section>
                <h3>But Matt, bytes are 8 bits?!?</h3>
                <div>Didn't we just make everything worse?</div>
            </section>
            <section>
                <h3>Worry not - Huffman to the rescue!</h3>
            </section>
        </section>

        <section>
            <section><h2>Huffman Trees</h2></section>
            <section>
                <pre class="compress">compress the compressible</pre>
                <table>
                    <tr>
                        <th>s</th>
                        <th>e</th>
                        <th>' '</th>
                        <th>r</th>
                        <th>p</th>
                        <th>m</th>
                        <th>o</th>
                        <th>c</th>
                        <th>l</th>
                        <th>b</th>
                        <th>i</th>
                        <th>h</th>
                        <th>t</th>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>4</td>
                        <td>2</td>
                        <td>2</td>
                        <td>2</td>
                        <td>2</td>
                        <td>2</td>
                        <td>2</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                    </tr>
                </table>
            </section>
            <section>
                <h2>Magic</h2>
            </section>
            <section>
                <table>
                    <tr>
                        <th>s</th>
                        <td class="compress">00</td>
                    </tr>
                    <tr>
                        <th>' '</th>
                        <td class="compress">010</td>
                    </tr>
                    <tr>
                        <th>l</th>
                        <td class="compress">0110</td>
                    </tr>
                    <tr>
                        <th>i</th>
                        <td class="compress">01110</td>
                    </tr>
                    <tr>
                        <th>b</th>
                        <td class="compress">01111</td>
                    </tr>
                    <tr>
                        <th>t</th>
                        <td class="compress">10000</td>
                    </tr>
                    <tr>
                        <th>h</th>
                        <td class="compress">10001</td>
                    </tr>
                    <tr>
                        <th>c</th>
                        <td class="compress">1001</td>
                    </tr>
                    <tr>
                        <th>e</th>
                        <td class="compress">101</td>
                    </tr>
                    <tr>
                        <th>p</th>
                        <td class="compress">1100</td>
                    </tr>
                    <tr>
                        <th>r</th>
                        <td class="compress">1101</td>
                    </tr>
                    <tr>
                        <th>o</th>
                        <td class="compress">1110</td>
                    </tr>
                    <tr>
                        <th>m</th>
                        <td class="compress">1111</td>
                    </tr>
                </table>
            </section>
            <section>
                <pre class="compress">compress the compressible</pre>
                <pre class="compress">1001 1110 1111 1100 1101 101 00 00 010 # compress_
10000 10001 101 010 # the_
1001 1110 1111 1100 1101 101 00 00 # compress
01110 01111 0110 101 # ible
                </pre>
            </section>
            <section><h2>but really</h2>
                backreference offset and length codes would be in the dictionary
            </section>

            <section>
                How often make tree?
                changes over time?
                gzip et al output and reset every ~64k
                At these boundaries...we only need the history of output!
                Make access points!
            </section>
        </section>

        <section>
            <section>
                <div class="outer">
                    <div class="top">
                        <form><textarea id="huffman-input" class="input"></textarea></form>
                        <div class="output">
                            <span class="bits"></span>
                            <br>
                            <span class="stats"></span>
                        </div>
                    </div>
                    <div class="bottom">
                        <svg class="huffman-input"></svg>
                    </div>
                </div>
            </section>
        </section>

        <section>
            <section>
                <h5>hellig thing does it too</h5>
            </section>
        </section>
    </div>

</div>

<script src="reveal.js/dist/reveal.js"></script>
<script src="reveal.js/plugin/highlight/highlight.js"></script>
<script type="module">
    Reveal.initialize({
        controls: true,
        progress: true,
        center: true,
        hash: true,
        width: 1280,
        height: 720,

        plugins: [RevealHighlight]
    });

    import {makeTree} from "./huffman.js";
    import {TreeView} from "./treeview.js";

    const $input = document.getElementById("huffman-input");
    $input.value = "compress the compressible";
    $input.oninput = () => update($input.value);
    $input.onchange = () => false;
    const treeView = new TreeView(d3.select("svg.huffman-input"));
    update($input.value);

    function update(text) {
        const tokens = text.split('');
        const tree = makeTree(tokens);
        const compressed = tree.compress(tokens);
        d3.select("div.output .bits").text(compressed);
        const bitsPerSymbol = Math.ceil(Math.log2(tree.numSymbols()));
        const bits = bitsPerSymbol * text.length;
        d3.select("div.output .stats").html(
            `Original: ${text.length} bytes, ${tree.numSymbols()} unique symbols, ${bitsPerSymbol} bps, ${bits} bits.<br>Compressed: ${compressed.replaceAll(' ', '').length} bits`);
        treeView.update(tree);
    }
</script>

</body>
</html>
