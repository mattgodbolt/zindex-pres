<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-dag@0.11.1"></script>
    <title>Huffman trees</title>
    <style>
        html {
            height: 100%;
        }

        body {
            margin: 0;
            height: 100%;
        }

        svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<form><label>To compress: <input id="input" type="text"></label></form>

<svg></svg>

<script type="module">
    import {makeTree} from "./huffman.js";


    const svgSelection = d3.select("svg");
    const edgesGroup = svgSelection.append("g");
    const nodesGroup = svgSelection.append("g");

    const $input = document.getElementById("input");
    $input.value = "compress the compressible";
    $input.oninput = () => {
        update($input.value);
    };
    update($input.value);

    function update(text) {
        window.tree = makeTree(text);

        const dag = d3.dagHierarchy()(window.tree.toDag());
        const nodeRadius = 40;
        const layout = d3
            .sugiyama() // base layout
            .coord(d3.coordSimplex())
            .nodeSize((node) => [(node ? 3.6 : 0.25) * nodeRadius, 3 * nodeRadius]);
        const {width, height} = layout(dag);

        svgSelection.attr("viewBox", [0, 0, width, height].join(" "));

        const transition = d3.transition()
            .duration(250)
            .ease(d3.easeCubic);

        // How to draw edges
        const line = d3
            .line()
            .curve(d3.curveCatmullRom)
            .x((d) => d.x)
            .y((d) => d.y);

        // Plot edges
        const edges = edgesGroup
            .selectAll("path")
            .data(dag.links());
        edges
            .enter()
            .append("path")
            .attr("fill", "none")
            .attr("stroke-width", 3)
            .attr("stroke", 'black')
            .merge(edges)
            .transition(transition)
            .attr("d", ({points}) => line(points))
        ;
        edges.exit().remove();

        // Select nodes
        const nodes = nodesGroup
            .selectAll("g")
            .data(dag.descendants());
        nodes.exit().remove();
        const nodesEnter = nodes
            .enter()
            .append("g");
        nodesEnter
            .attr("transform", ({x, y}) => `translate(${x}, ${y})`);
        nodes
            .transition(transition)
            .attr("transform", ({x, y}) => `translate(${x}, ${y})`);

        // Plot node circles
        const circle = nodesEnter.append("circle");
        circle.merge(nodes.select("circle"))
            .transition(transition)
            .attr("r", nodeRadius)
            .attr("fill", (n) => n.data.leaf ? "#ee3456" : "#888888");

        // Add text to nodes
        nodesEnter
            .append("text")
            .classed("token", true)
            .attr("transform", `translate(0,-${nodeRadius / 3})`)
            .attr("font-weight", "bold")
            .attr("font-size", "medium")
            .attr("font-family", "sans-serif")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .attr("fill", "white")
            .merge(nodes.select("text.token"))
            .text(d => d.data.token);
        nodesEnter
            .append("text")
            .classed("id", true)
            .attr("transform", `translate(0,${nodeRadius / 3})`)
            .attr("font-weight", "bold")
            .attr("font-size", "small")
            .attr("font-family", "sans-serif")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .attr("fill", "white")
            .merge(nodes.select("text.id"))
            .text(d => d.data.id);

    }
</script>

</body>
</html>