<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-dag@0.11.1"></script>
    <title>Huffman trees</title>
    <style>
        html {
            height: 100%;
        }

        body {
            margin: 0;
            height: 100%;
        }

        div.outer {
            display: flex;
            flex-direction: column;
        }
        div.top {
            flex-shrink: 0;
            flex-grow: 0;
        }
        div.bottom {
            flex-grow: 1;
        }
        textarea.input {
            display: block;
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            font-size: 7em;
            width: 80%;
        }

        .output {
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            width: 80%;
        }
        .output .bits {
            font-size: 5em;
            font-family: monospace;
        }
        .output .stats {
            font-size: 4em;
        }
    </style>
</head>
<body>

<div class="outer">
    <div class="top">
        <form><textarea id="input" class="input"></textarea></form>
        <div class="output">
            <span class="bits">1101011</span>
            <br>
            <span class="stats"></span>
        </div>
    </div>
    <div class="bottom">
        <svg></svg>
    </div>
</div>

<script type="module">
    import {makeTree} from "./huffman.js";


    const svgSelection = d3.select("svg");
    const edgesGroup = svgSelection.append("g");
    const nodesGroup = svgSelection.append("g");

    const $input = document.getElementById("input");
    $input.value = "compress the compressible";
    $input.oninput = () => {
        update($input.value);
    };
    update($input.value);

    function update(text) {
        const tree = makeTree(text);
        const compressed = tree.compress(text);
        d3.select("div.output .bits").text(compressed);
        d3.select("div.output .stats").text(
            `${text.length} original, ${compressed.replace(' ', '').length} bits compressed using ${tree.numSymbols()} symbols`);

        const dag = d3.dagHierarchy()(tree.toDag());
        const nodeRadius = 40;
        const layout = d3
            .sugiyama() // base layout
            .coord(d3.coordSimplex())
            .nodeSize((node) => [(node ? 3.6 : 0.25) * nodeRadius, 3 * nodeRadius]);
        const {width, height} = layout(dag);

        svgSelection.attr("viewBox", [0, 0, width, height].join(" "));

        const transition = d3.transition()
            .duration(250)
            .ease(d3.easeCubic);

        // How to draw edges
        const line = d3
            .line()
            .curve(d3.curveCatmullRom)
            .x((d) => d.x)
            .y((d) => d.y);

        // Plot edges
        const edges = edgesGroup
            .selectAll("path")
            .data(dag.links());
        edges
            .enter()
            .append("path")
            .attr("fill", "none")
            .attr("stroke-width", 3)
            .attr("stroke", 'black')
            .merge(edges)
            .transition(transition)
            .attr("d", ({points}) => line(points))
        ;
        edges.exit().remove();

        // Select nodes
        const nodes = nodesGroup
            .selectAll("g")
            .data(dag.descendants());
        nodes.exit().remove();
        const nodesEnter = nodes
            .enter()
            .append("g");
        nodesEnter
            .attr("transform", ({x, y}) => `translate(${x}, ${y})`);
        nodes
            .transition(transition)
            .attr("transform", ({x, y}) => `translate(${x}, ${y})`);

        // Plot node circles
        const circle = nodesEnter.append("circle");
        circle.merge(nodes.select("circle"))
            .transition(transition)
            .attr("r", nodeRadius)
            .attr("fill", (n) => n.data.leaf ? "#ee3456" : "#888888");

        // Add text to nodes
        nodesEnter
            .append("text")
            .classed("token", true)
            .attr("transform", `translate(0,-${nodeRadius / 3})`)
            .attr("font-weight", "bold")
            .attr("font-size", "medium")
            .attr("font-family", "sans-serif")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .attr("fill", "white")
            .merge(nodes.select("text.token"))
            .text(d => d.data.token);
        nodesEnter
            .append("text")
            .classed("id", true)
            .attr("transform", `translate(0,${nodeRadius / 3})`)
            .attr("font-weight", "bold")
            .attr("font-size", "small")
            .attr("font-family", "sans-serif")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "middle")
            .attr("fill", "white")
            .merge(nodes.select("text.id"))
            .text(d => d.data.id);

    }
</script>

</body>
</html>